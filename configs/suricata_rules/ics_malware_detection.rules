# -- SEO Tags (for GitHub indexing, GitHub Code Search, and doc generators) --
# Tags: ICS detection rules, SCADA threat detection, Suricata OT rules, Modbus attack detection, S7Comm threat rules
# Tags: TRITON detection, Stuxnet centrifuge sabotage, MITRE ATT&CK T0858 T0804 T0836 T0843 T0855 T0842
# Tags: industrial control system malware, OT red teaming, ICS blue team SIEM detection, PLC manipulation alerting
# Tags: Suricata ICS rule pack, SCADA protocol detection, OT threat simulation, ICS intrusion detection ruleset
# language: Suricata
# category: ICS_Malware



# Stuxnet and ICS Malware Detection Rules for Suricata
# Author: Ridpath (original), Improved by Grok 4
# GitHub: https://github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook
# Purpose: Detect Stuxnet and similar ICS malware patterns in OT networks
# Version: 2.1 - Enhanced with Pro Suggestions
# Changes from 2.0:
# - Added MITRE ATT&CK metadata for better attribution and SIEM/SOAR mapping
# - Added custom tags via metadata for rule filtering in deployments
# - Incorporated flowbits for chained detection logic (e.g., stuxnet_candidate)
# - Added priority levels to aid alert triage (1=Critical, 2=High, 3=Medium)
# - Included a companion YAML config block for rule metadata
# - Bonus: Added comments on unit testing with suri-test or suricata-verify; create PCAPs in tests/ directory for CI/CD validation
#
# Variables (define in suricata.yaml for production use)
# HOME_NET: [192.168.0.0/16]  # Your internal OT network
# EXTERNAL_NET: !$HOME_NET
# AUTHORIZED_MODBUS_CLIENTS: [192.168.1.50, 192.168.1.51]  # Authorized HMIs/Engineering stations
# SAFETY_NET: 192.168.100.0/24  # Safety system subnet
# ICS_PORTS: [102,502,20000,44818]  # Common ICS ports: S7Comm, Modbus, DNP3, ENIP/CIP

# Companion YAML Config (Optional: Store in configs/cheatsheet_rules.yml for log ingestion or GUI tools)
rule_meta:
  author: ridpath
  project: SCADA-OT-CheatSheet
  version: 2.1
  tags: [ICS, SCADA, Red Team, MITRE ATT&CK, Stuxnet, TRITON]
  supported_engines: [Suricata 6.x, 7.x]
  default_enabled: true
  classification: cheatsheet-lab

# Stuxnet S7Comm Centrifuge Manipulation Detection - High Speed
# Detects S7Comm commands manipulating centrifuge speeds above normal range (>1400 Hz, as in Stuxnet's 1410 Hz sabotage)
# Fixed: Removed conflicting byte_test; split into separate rules for high/low; used relative offsets properly
# Note: Assumes frequency value in 2 bytes after "|47 00|"; adjust offset if needed based on packet analysis
# MITRE: Manipulation of Control via parameter modification
# Tags: For filtering in large deployments
# Flowbits: Set for chained detection
# Priority: Critical due to potential physical damage
# Bonus: Test with suricata-verify using tests/stuxnet_high_speed.yaml and samples/stuxnet_high_speed.pcap
alert tcp $EXTERNAL_NET any -> $HOME_NET 102 ( \
    msg:"STUXNET_S7COMM_CENTRIFUGE_MANIPULATION_HIGH_SPEED"; \
    flow:established,to_server; \
    content:"|32 01 00 00|"; depth:4; \
    content:"|00 00 2F 00|"; distance:4; within:8; \
    content:"|47 00|"; distance:12; within:4; \
    byte_test:2,>,1400,0,relative; \
    flowbits:set,stuxnet_candidate; \
    threshold:type threshold, track by_src, count 3, seconds 60; \
    classtype:protocol-command-decode; \
    metadata: attack_technique=T0836, attack_tactic=Impair Process Control, malware_family=Stuxnet; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=stuxnet, tag=ics-malware; \
    priority:1; \
    sid:500001; rev:4; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
    reference:url,en.wikipedia.org/wiki/Stuxnet; \
)

# Stuxnet S7Comm Centrifuge Manipulation Detection - Low Speed
# Detects S7Comm commands manipulating centrifuge speeds below normal range (<800 Hz, as in Stuxnet's low-speed sabotage phases)
# New: Split from original to handle OR logic for abnormal speeds
# MITRE: Manipulation of Control via parameter modification
# Tags: For filtering in large deployments
# Flowbits: Set for chained detection
# Priority: Critical due to potential physical damage
# Bonus: Test with suricata-verify using tests/stuxnet_low_speed.yaml and samples/stuxnet_low_speed.pcap
alert tcp $EXTERNAL_NET any -> $HOME_NET 102 ( \
    msg:"STUXNET_S7COMM_CENTRIFUGE_MANIPULATION_LOW_SPEED"; \
    flow:established,to_server; \
    content:"|32 01 00 00|"; depth:4; \
    content:"|00 00 2F 00|"; distance:4; within:8; \
    content:"|47 00|"; distance:12; within:4; \
    byte_test:2,<,800,0,relative; \
    flowbits:set,stuxnet_candidate; \
    threshold:type threshold, track by_src, count 3, seconds 60; \
    classtype:protocol-command-decode; \
    metadata: attack_technique=T0836, attack_tactic=Impair Process Control, malware_family=Stuxnet; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=stuxnet, tag=ics-malware; \
    priority:1; \
    sid:500005; rev:2; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
    reference:url,en.wikipedia.org/wiki/Stuxnet; \
)

# Stuxnet S7Comm Timing Anomaly
# Detects rapid S7Comm write operations indicating timing-based attacks or reconnaissance
# Fixed: Removed invalid "sameip" and "window" keywords; used detection_filter for rate limiting; removed noalert to allow alerting on threshold
# Note: Sets flowbit for potential chaining with other rules; adjust count/seconds based on baseline traffic
# MITRE: Monitor Process State or similar discovery
# Tags: For filtering
# Flowbits: Existing s7comm_write; add stuxnet_candidate
# Priority: Medium as it's anomalous but not directly damaging
# Bonus: Test with suricata-verify using tests/stuxnet_timing_anomaly.yaml and samples/stuxnet_timing_anomaly.pcap
alert tcp $EXTERNAL_NET any -> $HOME_NET 102 ( \
    msg:"STUXNET_S7COMM_TIMING_ANOMALY"; \
    flow:established,to_server; \
    content:"|32 01|"; depth:2; \
    dsize:>100; \
    flowbits:set,s7comm_write; \
    flowbits:set,stuxnet_candidate; \
    detection_filter:track by_src, count 6, seconds 120; \
    classtype:suspicious-traffic; \
    metadata: attack_technique=T0801, attack_tactic=Discovery, malware_family=Stuxnet; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=stuxnet, tag=ics-malware; \
    priority:3; \
    sid:500002; rev:3; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
)

# Chained Stuxnet Detection Rule
# Detects persistent Stuxnet-like behavior after candidate flowbits set
# New: Based on flowbits chaining for multi-stage detection
# Priority: High as it indicates sustained activity
# Bonus: Test with suricata-verify using tests/persistent_stuxnet.yaml and samples/persistent_stuxnet.pcap
alert tcp $EXTERNAL_NET any -> $HOME_NET 102 ( \
    msg:"PERSISTENT STUXNET BEHAVIOR DETECTED"; \
    flow:established,to_server; \
    flowbits:isset,stuxnet_candidate; \
    threshold:type both, track by_src, count 3, seconds 600; \
    classtype:malware-cnc; \
    metadata: attack_technique=T0831, attack_tactic=Impair Process Control, malware_family=Stuxnet; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=stuxnet, tag=ics-malware; \
    priority:2; \
    sid:500010; rev:1; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
)

# TRITON TriStation Memory Write Detection
# Detects TRITON malware attempts to write to TriStation memory (UDP/1502)
# Improved: Added flow:to_server; corrected reference; added threshold to reduce FPs
# Note: Content matches potential TriStation headers; validate with PCAPs for accuracy
# MITRE: Program Download or Modify Controller Tasking
# Tags: For filtering
# Priority: Critical as it targets safety systems
# Bonus: Test with suricata-verify using tests/triton_memory_write.yaml and samples/triton_memory_write.pcap
alert udp $EXTERNAL_NET any -> $HOME_NET 1502 ( \
    msg:"TRITON_TRISTATION_MEMORY_WRITE"; \
    flow:to_server; \
    dsize:>200; \
    content:"|12 34|"; depth:2; \
    content:"|10 02|"; distance:2; within:2; \
    content:"|08 00 00 00|"; distance:4; within:8; \
    threshold:type threshold, track by_src, count 2, seconds 300; \
    classtype:attempted-admin; \
    metadata: attack_technique=T0843, attack_tactic=Impair Process Control, malware_family=TRITON; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=triton, tag=ics-malware; \
    priority:1; \
    sid:500003; rev:3; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
    reference:url,cisa.gov/news-events/ics-alerts/ics-alert-18-074-02a; \
)

# Safety System Program Mode Change Alert
# Detects attempts to change program mode in safety systems (e.g., TRITON-related)
# Improved: Used $SAFETY_NET variable; added flow:to_server
# MITRE: Change Operating Mode
# Tags: For filtering
# Priority: High as it inhibits safety functions
# Bonus: Test with suricata-verify using tests/safety_mode_change.yaml and samples/safety_mode_change.pcap
alert udp $EXTERNAL_NET any -> $SAFETY_NET 1502 ( \
    msg:"SAFETY_SYSTEM_PROGRAM_MODE_CHANGE"; \
    flow:to_server; \
    content:"|12 34|"; depth:2; \
    content:"|20 01|"; distance:2; within:2; \
    threshold:type threshold, track by_src, count 1, seconds 3600; \
    classtype:attempted-admin; \
    metadata: attack_technique=T0858, attack_tactic=Inhibit Response Function, malware_family=TRITON; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=triton, tag=ics-malware; \
    priority:2; \
    sid:500004; rev:3; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
)

# Modbus Write Operation from Unauthorized Source
# Detects Modbus write functions from non-authorized sources
# Improved: Used modbus keyword for better parsing/performance; negated source with !$AUTHORIZED_MODBUS_CLIENTS; removed raw content/byte_test
# Note: Matches any write access (coils/holding registers); enable modbus in suricata.yaml
# MITRE: Unauthorized Command Message
# Tags: For filtering
# Priority: High as unauthorized writes can impair control
# Bonus: Test with suricata-verify using tests/modbus_unauth_write.yaml and samples/modbus_unauth_write.pcap
alert modbus !$AUTHORIZED_MODBUS_CLIENTS any -> $HOME_NET any ( \
    msg:"MODBUS_WRITE_FROM_UNAUTHORIZED_SOURCE"; \
    modbus: access write; \
    classtype:protocol-command-decode; \
    metadata: attack_technique=T0855, attack_tactic=Impair Process Control; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=ics-malware; \
    priority:2; \
    sid:400001; rev:3; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
)

# ICS Protocol Scanning Detection
# Detects reconnaissance scanning on common ICS ports
# Improved: Used $ICS_PORTS variable; added flow:established for established connections only
# MITRE: Network Sniffing or Point & Tag Identification
# Tags: For filtering
# Priority: Medium as it's recon
# Bonus: Test with suricata-verify using tests/ics_recon.yaml and samples/ics_recon.pcap
alert tcp $EXTERNAL_NET any -> $HOME_NET $ICS_PORTS ( \
    msg:"ICS_PROTOCOL_RECONNAISSANCE"; \
    flow:established,to_server; \
    detection_filter:track by_src, count 10, seconds 30; \
    classtype:network-scan; \
    metadata: attack_technique=T0842, attack_tactic=Discovery; \
    metadata: tag=SCADA-OT-CHEATSHEET, tag=redteam, tag=ics-malware; \
    priority:3; \
    sid:400002; rev:3; gid:1; \
    reference:url,github.com/ridpath/SCADA-OT-CheatSheet-Advanced-ICS-Hacking-Playbook; \
)
